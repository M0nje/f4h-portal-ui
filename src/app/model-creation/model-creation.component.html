<div class="nav-path">
  <a mat-button [routerLink]="['/uclist']">Home</a>>><a mat-button [routerLink]="['/ucmenu']">Use case</a>>><a mat-button [routerLink]="['/mdashboard']">Model management</a>>><a mat-button color="primary"> {{componentDirection}}</a>
</div>

<mat-divider></mat-divider>

<p><b>Use case: </b> {{useCaseName}}</p>

<div class="content">

  <mat-horizontal-stepper [linear]="false" #stepper>
    <mat-step [stepControl]="formGroup1">
      <form [formGroup]="formGroup1">
        <ng-template matStepLabel>Name & description</ng-template>
        <mat-form-field appearance="fill">
          <mat-label>Model name</mat-label>
          <input matInput placeholder="Model name" formControlName="name" required>
        </mat-form-field>
        <br>
        <mat-form-field appearance="fill">
          <mat-label>Description</mat-label>
          <input matInput placeholder="Description" formControlName="description" required>
        </mat-form-field>
        <div>
          <button mat-button matStepperNext [disabled]="!formGroup1.valid && !newDMModel['model_id']">Next</button>
          
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="formGroup2">
      <form [formGroup]="formGroup2">
        <ng-template matStepLabel>Data set selection</ng-template>
          <table mat-table [dataSource]='datasetSelectionDataSource' class="mat-elevation-z8">
          
            <!-- Radio button Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef>
              </th>
              <td mat-cell *matCellDef="let row" >

                <div *ngIf="selectedDataSet">
                  <mat-radio-button [value]="row" *ngIf="row.dataset_id != selectedDataSet.dataset_id" (change)="selectDataSet(row)"></mat-radio-button>
                  <mat-radio-button [value]="row" *ngIf="row.dataset_id === selectedDataSet.dataset_id" checked="true"></mat-radio-button>  
                </div>
                <div *ngIf="!selectedDataSet">
                  <mat-radio-button [value]="row" (change)="selectDataSet(row)"></mat-radio-button>  
                </div>
                </td>
            </ng-container> 

            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef> Name </th>
              <td mat-cell *matCellDef="let element"> {{element.name}} </td>
            </ng-container>
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef> Description </th>
              <td mat-cell *matCellDef="let element"> {{element.description}} </td>
            </ng-container>
            <ng-container matColumnDef="data_sources">
              <th mat-header-cell *matHeaderCellDef> Agents </th>
              <td mat-cell *matCellDef="let element"> {{element.dataset_sources.length}} </td>
            </ng-container>
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef> Status </th>
              <td mat-cell *matCellDef="let element"> {{element.execution_state}} </td>
            </ng-container>
            <ng-container matColumnDef="created_by">
              <th mat-header-cell *matHeaderCellDef> Created by </th>
              <td mat-cell *matCellDef="let element"> {{element.created_by}} </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="datasetSelectionDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: datasetSelectionDisplayedColumns;"></tr>
          </table>
        <div>
          
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext [disabled]="!formGroup2.valid && !newDMModel['model_id']">Next</button>
        </div>
      </form>
    </mat-step>
    <mat-step [stepControl]="formGroup3">
     
      <form [formGroup]="formGroup3">
        <ng-template matStepLabel>Categorical variables</ng-template>

        <table mat-table [dataSource]="categorigalVariablesDataSource" class="mat-elevation-z8">

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef> Name </th>
            <td mat-cell *matCellDef="let element"> {{element.name}} </td>
          </ng-container>
        
          <ng-container matColumnDef="fhir_path">
            <th mat-header-cell *matHeaderCellDef> FHIR path </th>
            <td mat-cell *matCellDef="let element"> {{element.fhir_path}} </td>
          </ng-container>
        
          <ng-container matColumnDef="fhir_query">
            <th mat-header-cell *matHeaderCellDef> FHIR query </th>
            <td mat-cell *matCellDef="let element"> {{element.fhir_query}} </td>
          </ng-container>
        
          <ng-container matColumnDef="variable_type">
            <th mat-header-cell *matHeaderCellDef> Type </th>
            <td mat-cell *matCellDef="let element"> {{element.variable_type}} </td>
          </ng-container>
        
          <tr mat-header-row *matHeaderRowDef="categorialVariablesColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: categorialVariablesColumns;"></tr>
        </table>

        <div>
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext>Next</button>
        </div>
      </form>
    </mat-step>
    <mat-step [stepControl]="formGroup4">
      <form [formGroup]="formGroup4">
        <ng-template matStepLabel>Missing Data</ng-template>

        <table mat-table [dataSource]="missingDataDataSource" class="mat-elevation-z8">

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef> Variable name </th>
            <td mat-cell *matCellDef="let element"> {{element.name}} </td>
          </ng-container>
        
          <ng-container matColumnDef="variable_type">
            <th mat-header-cell *matHeaderCellDef> Type </th>
            <td mat-cell *matCellDef="let element"> {{element.variable_data_type}} </td>
          </ng-container>
        
          <ng-container matColumnDef="operation">
            <th mat-header-cell *matHeaderCellDef class="operation-column"> Operation </th>
            <td mat-cell *matCellDef="let element"> 
              <mat-select [value]="element.missing_data_operation" name="operations" [disabled]="isDisabled" class="select-operation" (selectionChange)="saveOperations($event.value, element)">
                <mat-option *ngFor="let op of operations" [value]="op.value" >
                  {{op.viewValue}}
                </mat-option>
              </mat-select>
              </td>
          </ng-container>
        
          <ng-container matColumnDef="value">
            <th mat-header-cell *matHeaderCellDef class="value-column"> Value </th>
            <td mat-cell *matCellDef="let element"> 
                <input  *ngIf="element.missing_data_operation === 'set_specific'" 
                      [value]="element.missing_data_specific_value" 
                      class="operation-input"
                      #operator_value
                      (change)="specificValueChange(operator_value, element)"
                      [disabled]="isDisabled">
            </td>
          </ng-container>
        
          <tr mat-header-row *matHeaderRowDef="missingDataColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: missingDataColumns;"></tr>
        </table>

        <div>
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext >Next</button>
        </div>
      </form>
    </mat-step>
    <mat-step [stepControl]="formGroup5">
      <form [formGroup]="formGroup5">
        <ng-template matStepLabel>Algorithm selection</ng-template>

          <!-- Algorithm section -->
          <div class="algorithm-section">

            <!-- algorithm definition form -->
            <div class="algorithm-definition">
              <mat-form-field appearance="fill">
                <mat-label>Algorithm</mat-label>
                <mat-select name="algorithmName" (selectionChange)="onChangeAlgorithm($event.value)" [disabled]="isDisabled">
                  <mat-option *ngFor="let algorithm of algorithms" [value]="algorithm">
                    {{algorithm.display}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <br>
              <mat-form-field *ngFor="let input of algorithmParameterForm" appearance="legacy">
                <mat-label>{{input.display}}</mat-label>
                <input matInput [formControlName]="input.name" [disabled]="isDisabled">
              </mat-form-field>
              <button [disabled]="isDisabled" mat-raised-button color="primary" class="add-algorithm-btn" (click)="addAlgorithm()"> Add </button>
            </div>

            <!-- list of algorithms -->
            <div class="algorithm-list">
              <div class="algorithm-created" *ngFor="let algorithm of algorithmsList">
                <div class="alg-label">
                  <b>Algorithm: </b>
                </div>
                <div class="alg-value">
                  {{algorithm.name}}
                </div> <br>

                <div *ngFor="let parameter of algorithm.parameters">
                  <div class="alg-label">
                    <b>{{parameter.name}}: </b>
                  </div>
                  <div class="alg-value">
                    {{parameter.value}}
                  </div> <br>
                </div>
                
              </div>
            </div>
          </div>
          
        <div>
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext [disabled]="algorithmsList.length == 0 && !newDMModel['model_id']">Next</button>
        </div>
      </form>
    </mat-step>
    <mat-step [stepControl]="formGroup6">
      <form [formGroup]="formGroup6">
        <ng-template matStepLabel>Parameters</ng-template>
        <div class="params-container">

          <mat-card class="params-card">

            <div class="grid">
              <div class="col-1">

                <label class="label-param">Trainig size</label> 
                <small class="little-letter">Data set to be used for train the model.</small>
                <label class="label-param">Test size</label>
                <small class="little-letter">Data set to evaluate the model once it is created.</small>
              </div>
              <div class="col-2">
                <mat-slider
                  thumbLabel
                  tickInterval="10"
                  min="1"
                  max="100"
                  class="slider-btn"
                  formControlName="training_size"
                  name="test_size"
                  (input)="changeTraining($event)">
                </mat-slider>

                <mat-slider
                  thumbLabel
                  tickInterval="10"
                  min="1"
                  max="100"
                  class="slider-btn"
                  formControlName="test_size"
                  disabled="true">
                </mat-slider> 


              </div>
              <div class="col-3">
                <label > {{formGroup6.controls.training_size.value / 100}} </label>
                <br>
                <label > {{formGroup6.controls.test_size.value / 100}}</label>
                <br>
              </div>

            </div>

          </mat-card>

        </div>

        <div>
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext (click)="onSave()" [disabled]="!formGroup6.valid && !newDMModel['model_id']">Save and Next</button>
          
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="formGroup7">
      <form [formGroup]="formGroup7">
        <ng-template matStepLabel>Generate & Completed</ng-template>

          <div *ngIf="newDMModel['data_mining_state'] === 'training' || !newDMModel['data_mining_state']" class="not-ready-panel">
          
            <mat-spinner></mat-spinner>
            <p>Generating Model...</p>

          </div>
          <div *ngIf="newDMModel['data_mining_state'] === 'final' || newDMModel['data_mining_state'] === 'ready'" class="boosted_models_panel">

            <mat-card class="statistics-cards" *ngFor="let bustedModel of this.newDMModel['boosted_models']">

              <div class="algorithm-description">
                <div>
                  <h3>{{bustedModel['algorithm']['name']}}</h3>
                </div>
                
                <div class="param-cont" *ngFor="let value of bustedModel['algorithm']['parameters']">
                  <div class="param-name">
                    <b>{{ value.name }}:</b>
                  </div>
                  <div class="param-value">
                    <p>{{ value.name }}: {{ value.value }}</p>
                  </div>
                </div>
              </div>

              <table mat-table [dataSource]="statistics" class="mat-elevation-z8">
                <ng-container matColumnDef="statistics">
                  <th mat-header-cell *matHeaderCellDef> Statistics </th>
                  <td mat-cell *matCellDef="let element"> {{element.name}} </td>
                </ng-container>
                <ng-container matColumnDef="results">
                  <th mat-header-cell *matHeaderCellDef> Training results </th>
                  <td mat-cell *matCellDef="let element"> {{element.value}} </td>
                </ng-container>
  
                <tr mat-header-row *matHeaderRowDef="statisticsColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: statisticsColumns;"></tr>
              </table>
              <br>
              <button mat-raised-button color="primary" class="add-algorithm-btn" (click)="selectBostedModel(bustedModel)">Select</button>
            </mat-card>
          </div>
        <div>
          <button mat-button matStepperPrevious>Back</button>
        </div>
      </form>
    </mat-step>
  </mat-horizontal-stepper>
</div>


